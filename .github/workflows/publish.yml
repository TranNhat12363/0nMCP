# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 0nMCP â€” Publish to NPM + GitHub Packages
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Triggers on:
#   1. Push a version tag (v1.2.3) â†’ full publish
#
# Publishes to:
#   - npmjs.com/package/0nmcp
#   - github.com/0nork/0nMCP/packages (GitHub Packages)
#
# Uses GITHUB_TOKEN (not PAT) per GitHub best practices:
# https://docs.github.com/en/packages/managing-github-packages-using-github-actions-workflows/publishing-and-installing-a-package-with-github-actions
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Publish 0nMCP

on:
  push:
    tags:
      - 'v*'          # Publish on version tags (v1.3.0, v1.3.1, etc.)

# Cancel in-progress runs for same ref
concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€ Step 1: Generate stats from catalog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  stats:
    name: ðŸ“Š Generate Stats
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tools: ${{ steps.stats.outputs.tools }}
      services: ${{ steps.stats.outputs.services }}
      actions: ${{ steps.stats.outputs.actions }}
      triggers: ${{ steps.stats.outputs.triggers }}
      total: ${{ steps.stats.outputs.total }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate stats from catalog
        id: stats
        run: |
          node scripts/generate-stats.js --all
          
          # Parse stats.json for outputs
          TOOLS=$(jq '.tools' lib/stats.json)
          SERVICES=$(jq '.services' lib/stats.json)
          ACTIONS=$(jq '.actions' lib/stats.json)
          TRIGGERS=$(jq '.triggers' lib/stats.json)
          TOTAL=$(jq '.totalCapabilities' lib/stats.json)
          
          echo "tools=$TOOLS" >> $GITHUB_OUTPUT
          echo "services=$SERVICES" >> $GITHUB_OUTPUT
          echo "actions=$ACTIONS" >> $GITHUB_OUTPUT
          echo "triggers=$TRIGGERS" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Stats: $TOOLS tools, $SERVICES services, $ACTIONS actions, $TRIGGERS triggers ($TOTAL total)"

  # â”€â”€â”€ Step 2: Publish to NPM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-npm:
    name: ðŸ“¦ Publish to NPM
    needs: stats
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write    # For npm provenance

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js for NPM
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Regenerate stats before publish
        run: node scripts/generate-stats.js --all

      - name: Install dependencies
        run: npm ci --ignore-scripts 2>/dev/null || npm install --ignore-scripts

      - name: Publish to NPM with provenance
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify publication
        run: |
          sleep 5
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Checking for 0nmcp@$VERSION on NPM..."
          npm view 0nmcp@$VERSION version

  # â”€â”€â”€ Step 3: Publish to GitHub Packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-github:
    name: ðŸ“¦ Publish to GitHub Packages
    needs: stats
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write    # GITHUB_TOKEN needs packages:write

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js for GitHub Packages
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@0nork'

      - name: Regenerate stats before publish
        run: node scripts/generate-stats.js --all

      # Temporarily scope the package for GitHub Packages
      - name: Configure for GitHub Packages
        run: |
          # Create a GitHub Packages-specific package.json
          # GitHub Packages requires scoped packages (@org/name)
          node -e "
            const pkg = require('./package.json');
            pkg.name = '@0nork/0nmcp';
            pkg.publishConfig = {
              registry: 'https://npm.pkg.github.com'
            };
            require('fs').writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          "

      - name: Publish to GitHub Packages
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€ Step 4: Create GitHub Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  release:
    name: ðŸš€ Create Release
    needs: [publish-npm, publish-github, stats]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s" --no-merges)
          else
            CHANGES=$(git log --pretty=format:"- %s" --no-merges -20)
          fi
          
          # Write to file to avoid quoting issues
          cat > /tmp/release-notes.md << 'NOTES_EOF'
          ## ðŸ“Š Stats
          
          | Metric | Count |
          |--------|-------|
          | Services | ${{ needs.stats.outputs.services }} |
          | Tools | ${{ needs.stats.outputs.tools }} |
          | Actions | ${{ needs.stats.outputs.actions }} |
          | Triggers | ${{ needs.stats.outputs.triggers }} |
          | **Total Capabilities** | **${{ needs.stats.outputs.total }}** |
          
          ## Install
          
          ```bash
          npx 0nmcp
          ```
          
          ## Changes
          
          NOTES_EOF
          echo "$CHANGES" >> /tmp/release-notes.md

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          body_path: /tmp/release-notes.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
