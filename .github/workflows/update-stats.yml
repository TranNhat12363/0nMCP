# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 0nMCP â€” Verify Stats Are Up-to-Date
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# When lib/catalog.json is modified, verify that stats files
# are also updated. Fails if stats are stale.
#
# Stats are generated LOCALLY via npm scripts:
#   - prepublishOnly: node scripts/generate-stats.js --all
#   - preversion: node scripts/generate-stats.js --all
#
# This workflow does NOT push to main. It only verifies.
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: Verify Stats

on:
  push:
    branches: [main]
    paths:
      - 'lib/catalog.json'      # Only run when catalog changes

jobs:
  verify-stats:
    name: ğŸ“Š Verify Stats Are Current
    runs-on: ubuntu-latest
    permissions:
      contents: read             # Read-only â€” never pushes

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate stats and check for drift
        run: |
          # Save current committed stats
          cp lib/stats.json /tmp/stats-before.json
          cp lib/badges.json /tmp/badges-before.json

          # Regenerate
          node scripts/generate-stats.js --all

          # Compare
          if ! diff -q lib/stats.json /tmp/stats-before.json > /dev/null 2>&1; then
            echo "âš ï¸  Stats are out of date. Run 'npm run stats' locally and commit."
            echo ""
            echo "Diff:"
            diff /tmp/stats-before.json lib/stats.json || true
            exit 1
          fi

          if ! diff -q lib/badges.json /tmp/badges-before.json > /dev/null 2>&1; then
            echo "âš ï¸  Badges are out of date. Run 'npm run stats' locally and commit."
            exit 1
          fi

          echo "âœ… Stats are up to date"
